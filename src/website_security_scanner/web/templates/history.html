{% extends "base.html" %}

{% block title %}Scan History - Low-Code Security Scanner{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Scan History</h1>
        <p class="text-gray-600">Browse and manage your past security scans</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                <select id="filter-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="running">Running</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Platform</label>
                <select id="filter-platform" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">All Platforms</option>
                    <option value="bubble">Bubble.io</option>
                    <option value="outsystems">OutSystems</option>
                    <option value="airtable">Airtable</option>
                    <option value="unknown">Generic/Unknown</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search URL</label>
                <input type="text" id="search-url" placeholder="Search by URL..."
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="flex items-end">
                <button onclick="applyFilters()" 
                        class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">
                    <i class="fas fa-filter mr-2"></i> Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Scan History Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        URL
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Platform
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Vulnerabilities
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Date
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody id="history-tbody" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                        Loading scan history...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-between items-center">
        <p class="text-sm text-gray-700">
            Showing <span id="showing-from">0</span> to <span id="showing-to">0</span> of 
            <span id="total-scans">0</span> scans
        </p>
        <div class="flex space-x-2">
            <button onclick="previousPage()" id="btn-prev"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50"
                    disabled>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button onclick="nextPage()" id="btn-next"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allScans = [];
    let filteredScans = [];
    let currentPage = 1;
    const itemsPerPage = 20;

    async function loadHistory() {
        try {
            const response = await fetch('/api/history');
            const data = await response.json();
            allScans = data.history.reverse();
            filteredScans = allScans;
            renderTable();
        } catch (error) {
            console.error('Failed to load history:', error);
            document.getElementById('history-tbody').innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-red-500">
                        Failed to load scan history
                    </td>
                </tr>
            `;
        }
    }

    function applyFilters() {
        const statusFilter = document.getElementById('filter-status').value;
        const platformFilter = document.getElementById('filter-platform').value;
        const searchQuery = document.getElementById('search-url').value.toLowerCase();

        filteredScans = allScans.filter(scan => {
            if (statusFilter && scan.status !== statusFilter) return false;
            if (platformFilter && scan.platform !== platformFilter) return false;
            if (searchQuery && !scan.url.toLowerCase().includes(searchQuery)) return false;
            return true;
        });

        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('history-tbody');
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageScans = filteredScans.slice(start, end);

        if (pageScans.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                        No scans found
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = pageScans.map(scan => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900 truncate max-w-xs" title="${scan.url}">
                        ${scan.url}
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900">${scan.platform || 'Unknown'}</div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-block px-2 py-1 rounded text-xs text-white ${getStatusClass(scan.status)}">
                        ${scan.status}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900">
                        ${scan.vulnerability_count || 0}
                        ${scan.critical_count ? `<span class="text-red-600">(${scan.critical_count} critical)</span>` : ''}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${formatDate(scan.created_at)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${scan.status === 'completed' ? `
                        <a href="/api/scan/${scan.id}/report" 
                           class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-download"></i>
                        </a>
                    ` : ''}
                    <button onclick="viewDetails('${scan.id}')" 
                            class="text-green-600 hover:text-green-900">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        // Update pagination
        document.getElementById('showing-from').textContent = start + 1;
        document.getElementById('showing-to').textContent = Math.min(end, filteredScans.length);
        document.getElementById('total-scans').textContent = filteredScans.length;

        document.getElementById('btn-prev').disabled = currentPage === 1;
        document.getElementById('btn-next').disabled = end >= filteredScans.length;
    }

    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    }

    function nextPage() {
        if ((currentPage * itemsPerPage) < filteredScans.length) {
            currentPage++;
            renderTable();
        }
    }

    async function viewDetails(scanId) {
        window.location.href = `/scan?view=${scanId}`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        
        // Refresh every 30 seconds
        setInterval(loadHistory, 30000);
    });
</script>
{% endblock %}
