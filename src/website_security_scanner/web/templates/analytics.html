<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Low-Code Security Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-shield-alt text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-800">Low-Code Security Scanner</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-blue-600">Dashboard</a>
                    <a href="/scan" class="text-gray-600 hover:text-blue-600">New Scan</a>
                    <a href="/reports" class="text-gray-600 hover:text-blue-600">Reports</a>
                    <a href="/analytics" class="text-blue-600 font-medium">Analytics</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Security Analytics</h2>
            <p class="text-gray-600">Advanced analytics and trends for low-code platform security</p>
        </div>

        <!-- Analytics Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Vulnerability Trends -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Vulnerability Trends Over Time</h3>
                <canvas id="trendsChart" width="400" height="300"></canvas>
            </div>

            <!-- Platform Comparison -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Platform Security Comparison</h3>
                <canvas id="platformComparisonChart" width="400" height="300"></canvas>
            </div>

            <!-- Vulnerability Types -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Common Vulnerability Types</h3>
                <canvas id="vulnerabilityTypesChart" width="400" height="300"></canvas>
            </div>

            <!-- Risk Score Distribution -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Risk Score Distribution</h3>
                <canvas id="riskScoreChart" width="400" height="300"></canvas>
            </div>
        </div>

        <!-- Detailed Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-800 mb-2">Average Vulnerabilities per Scan</h4>
                <p class="text-3xl font-bold text-blue-600" id="avgVulns">0</p>
                <p class="text-sm text-gray-500 mt-1">Across all platforms</p>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-800 mb-2">Most Vulnerable Platform</h4>
                <p class="text-3xl font-bold text-red-600" id="mostVulnerable">-</p>
                <p class="text-sm text-gray-500 mt-1" id="mostVulnerableCount">0 vulnerabilities</p>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h4 class="text-lg font-medium text-gray-800 mb-2">Scan Success Rate</h4>
                <p class="text-3xl font-bold text-green-600" id="successRate">0%</p>
                <p class="text-sm text-gray-500 mt-1">Completed scans</p>
            </div>
        </div>

        <!-- Top Vulnerabilities Table -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-800">Top Vulnerability Patterns</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vulnerability Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average Severity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platforms Affected</th>
                        </tr>
                    </thead>
                    <tbody id="vulnerabilityTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Vulnerability data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Load analytics data
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/scans');
                const scans = await response.json();
                processAnalyticsData(scans);
            } catch (error) {
                console.error('Failed to load analytics data:', error);
            }
        }

        function processAnalyticsData(scans) {
            // Calculate metrics
            const completedScans = scans.filter(s => s.status === 'completed');
            const totalVulns = completedScans.reduce((sum, scan) => sum + (scan.vulnerabilities || []).length, 0);
            const avgVulns = completedScans.length > 0 ? (totalVulns / completedScans.length).toFixed(1) : 0;

            // Platform vulnerability counts
            const platformVulns = {};
            completedScans.forEach(scan => {
                const platform = scan.platform || 'Unknown';
                platformVulns[platform] = (platformVulns[platform] || 0) + (scan.vulnerabilities || []).length;
            });

            const mostVulnerable = Object.keys(platformVulns).reduce((a, b) =>
                platformVulns[a] > platformVulns[b] ? a : b, 'None');

            // Success rate
            const successRate = scans.length > 0 ? ((completedScans.length / scans.length) * 100).toFixed(1) : 0;

            // Update metrics
            document.getElementById('avgVulns').textContent = avgVulns;
            document.getElementById('mostVulnerable').textContent = mostVulnerable;
            document.getElementById('mostVulnerableCount').textContent =
                `${platformVulns[mostVulnerable] || 0} vulnerabilities`;
            document.getElementById('successRate').textContent = `${successRate}%`;

            // Create charts
            createTrendsChart(scans);
            createPlatformComparisonChart(platformVulns);
            createVulnerabilityTypesChart(scans);
            createRiskScoreChart(scans);
            createVulnerabilityTable(scans);
        }

        function createTrendsChart(scans) {
            // Group by date
            const dateGroups = {};
            scans.forEach(scan => {
                if (scan.start_time) {
                    const date = new Date(scan.start_time).toISOString().split('T')[0];
                    dateGroups[date] = (dateGroups[date] || 0) + (scan.vulnerabilities || []).length;
                }
            });

            const dates = Object.keys(dateGroups).sort();
            const values = dates.map(date => dateGroups[date]);

            new Chart(document.getElementById('trendsChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Vulnerabilities Found',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createPlatformComparisonChart(platformVulns) {
            new Chart(document.getElementById('platformComparisonChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(platformVulns),
                    datasets: [{
                        label: 'Vulnerabilities',
                        data: Object.values(platformVulns),
                        backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createVulnerabilityTypesChart(scans) {
            const vulnTypes = {};
            scans.forEach(scan => {
                (scan.vulnerabilities || []).forEach(vuln => {
                    vulnTypes[vuln.type] = (vulnTypes[vuln.type] || 0) + 1;
                });
            });

            const topTypes = Object.entries(vulnTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            new Chart(document.getElementById('vulnerabilityTypesChart'), {
                type: 'doughnut',
                data: {
                    labels: topTypes.map(([type]) => type),
                    datasets: [{
                        data: topTypes.map(([,count]) => count),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6',
                            '#f97316', '#06b6d4', '#84cc16', '#ec4899', '#6b7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createRiskScoreChart(scans) {
            const riskScores = scans.map(scan => (scan.vulnerabilities || []).length);
            const buckets = { '0': 0, '1-5': 0, '6-10': 0, '11-20': 0, '20+': 0 };

            riskScores.forEach(score => {
                if (score === 0) buckets['0']++;
                else if (score <= 5) buckets['1-5']++;
                else if (score <= 10) buckets['6-10']++;
                else if (score <= 20) buckets['11-20']++;
                else buckets['20+']++;
            });

            new Chart(document.getElementById('riskScoreChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(buckets),
                    datasets: [{
                        label: 'Number of Scans',
                        data: Object.values(buckets),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createVulnerabilityTable(scans) {
            const vulnStats = {};
            const platformStats = {};

            scans.forEach(scan => {
                const platform = scan.platform || 'Unknown';
                (scan.vulnerabilities || []).forEach(vuln => {
                    if (!vulnStats[vuln.type]) {
                        vulnStats[vuln.type] = {
                            count: 0,
                            severities: [],
                            platforms: new Set()
                        };
                    }
                    vulnStats[vuln.type].count++;
                    vulnStats[vuln.type].severities.push(vuln.severity);
                    vulnStats[vuln.type].platforms.add(platform);
                });
            });

            const tbody = document.getElementById('vulnerabilityTableBody');
            const sortedVulns = Object.entries(vulnStats)
                .sort(([,a], [,b]) => b.count - a.count)
                .slice(0, 10);

            tbody.innerHTML = sortedVulns.map(([type, stats]) => {
                const avgSeverity = stats.severities.reduce((sum, sev) => {
                    const scores = { 'High': 3, 'Medium': 2, 'Low': 1, 'Info': 0 };
                    return sum + (scores[sev] || 0);
                }, 0) / stats.severities.length;

                const severityText = avgSeverity >= 2.5 ? 'High' :
                                   avgSeverity >= 1.5 ? 'Medium' :
                                   avgSeverity >= 0.5 ? 'Low' : 'Info';

                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stats.count}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${severityText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stats.platforms.size} platforms</td>
                    </tr>
                `;
            }).join('');
        }

        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', loadAnalytics);
    </script>
</body>
</html>