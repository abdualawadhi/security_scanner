import unittest
from urllib.parse import urlparse, unquote

from website_security_scanner.analyzers.vulnerability_detection import (
    XSSDetector,
    SQLInjectionDetector,
    OpenRedirectDetector,
)


class FakeElapsed:
    def __init__(self, seconds: float = 0.1):
        self._seconds = seconds

    def total_seconds(self):
        return self._seconds


class FakeResponse:
    def __init__(self, text="", status_code=200, headers=None, elapsed=0.1, request_url=""):
        self.text = text
        self.status_code = status_code
        self.headers = headers or {}
        self.elapsed = FakeElapsed(elapsed)
        self.request = type("Req", (), {"method": "GET", "url": request_url, "path_url": urlparse(request_url).path, "headers": {}})()


class FakeSession:
    def get(self, url, timeout=10, allow_redirects=True):
        url_lower = url.lower()
        if "sqli" in url_lower or "select" in url_lower or "'" in url or "%27" in url_lower:
            return FakeResponse(text="You have an error in your SQL syntax", request_url=url)
        if "evil.com" in url_lower or "attacker.com" in url_lower:
            return FakeResponse(text="", status_code=302, headers={"Location": "https://evil.com"}, request_url=url)
        if "xss" in url_lower or "<script>" in url_lower or "%3c" in url_lower:
            return FakeResponse(text=unquote(url), request_url=url)
        return FakeResponse(text="ok", request_url=url)


class VulnerabilityDetectionTests(unittest.TestCase):
    def test_xss_returns_response(self):
        session = FakeSession()
        detector = XSSDetector(session)
        url = "https://example.com/?q=test"
        vulns = detector.detect_reflected_xss(url, FakeResponse(text="test", request_url=url), "test")
        self.assertTrue(vulns)
        self.assertIn("response", vulns[0])

    def test_sqli_returns_response(self):
        session = FakeSession()
        detector = SQLInjectionDetector(session)
        url = "https://example.com/?id=1"
        vulns = detector.detect_sql_injection(url, FakeResponse(text="ok", request_url=url))
        sqli = [v for v in vulns if v.get("type") == "SQL Injection"]
        self.assertTrue(sqli)
        self.assertIn("response", sqli[0])

    def test_open_redirect_returns_response(self):
        session = FakeSession()
        detector = OpenRedirectDetector(session)
        url = "https://example.com/?redirect=/"
        from bs4 import BeautifulSoup
        soup = BeautifulSoup("<html></html>", "html.parser")
        vulns = detector.detect_open_redirect(url, FakeResponse(text="ok", request_url=url), soup)
        redirects = [v for v in vulns if v.get("type") == "Open Redirect"]
        self.assertTrue(redirects)
        self.assertIn("response", redirects[0])


if __name__ == "__main__":
    unittest.main()
